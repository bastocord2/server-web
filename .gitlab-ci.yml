image: docker:stable

stages:
- pre-build
- build
- test
- deploy 


build-docker:
  services:
    - docker:dind
  before_script:
    - docker info
    - docker login -u bastcord -p @Mz01098Docker!

  stage: pre-build
  tags:
    - gitlab-org-docker
    
  script:
  - docker build -t minha-imagem .
  - docker tag minha-imagem bastcord/prod:1.0
  - docker push bastcord/prod:1.0

build-project:
  image: bastcord/prod:1.0
  retry: 2 
  services:
  - docker:dind
  - mysql:5.7
  variables:
    MYSQL_USER: devops_dev 
    MYSQL_PASSWORD: mestre5000 
    MYSQL_DATABASE: todo_dev 
    MYSQL_ROOT_PASSWORD: senha 

    DB_NAME: 'todo_dev'
    DB_USER: 'devops_dev'
    DB_PASSWORD: 'mestre5000'
    DB_PORT: '3306'
    DB_HOST: 'mysql'
    SECRET_KEY: 'r*5ltfzw-61ksdm41fuul8+hxs$86yo9%k1%k=(!@=-wv4qtyv'

  stage: build
  tags:
  - gitlab-org-docker
  dependencies:
  - build-docker
  script:
  - python manage.py makemigrations
  - python manage.py migrate
  - echo " passou!!!"


